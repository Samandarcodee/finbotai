"""
handlers/ai.py
Handles AI advice and AI analysis for FinBot AI Telegram bot.
"""

import asyncio
from telegram import Update, ReplyKeyboardMarkup, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.constants import ParseMode
from db import get_db_connection, get_user_settings, DB_PATH
from utils import format_amount
from ai_service import ai_service
from loguru import logger
import sqlite3
from datetime import datetime, timedelta
import json
from telegram.ext import ContextTypes
from telegram.ext import ConversationHandler

# MESSAGES constant
MESSAGES = {
    "uz": {
        "ai_menu": "ü§ñ <b>AI VOSITALAR</b>\n\nQuyidagi AI funksiyalaridan birini tanlang:",
        "loading": "üß† AI hisob-kitob qilmoqda...",
        "no_data": "‚ùå AI tahlil uchun ma'lumot yetarli emas. Avval kirim/chiqim qo'shing!",
        "ai_error": "‚ùå AI xizmatida muammo bor. Keyinroq urinib ko'ring.",
        "budget_advice": "üí∞ <b>AI Byudjet Tavsiyasi:</b>",
        "spending_analysis": "üìä <b>AI Xarajatlar Tahlili:</b>",
        "goal_monitoring": "üéØ <b>AI Maqsad Monitoring:</b>",
        "financial_advice": "üí° <b>AI Moliyaviy Maslahat:</b>",
        "savings_tips": "üíé <b>AI Tejash Maslahatlari:</b>",
        "investment_advice": "üìà <b>AI Investitsiya Maslahati:</b>",
        "back_to_ai": "üîô AI menyuga qaytish"
    },
    "ru": {
        "ai_menu": "ü§ñ <b>AI –ò–ù–°–¢–†–£–ú–ï–ù–¢–´</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ AI —Ñ—É–Ω–∫—Ü–∏–π:",
        "loading": "üß† AI –≤—ã—á–∏—Å–ª—è–µ—Ç...",
        "no_data": "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞. –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –¥–æ—Ö–æ–¥—ã/—Ä–∞—Å—Ö–æ–¥—ã!",
        "ai_error": "‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å AI —Å–µ—Ä–≤–∏—Å–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
        "budget_advice": "üí∞ <b>AI –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±—é–¥–∂–µ—Ç—É:</b>",
        "spending_analysis": "üìä <b>AI –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤:</b>",
        "goal_monitoring": "üéØ <b>AI –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–ª–µ–π:</b>",
        "financial_advice": "üí° <b>AI –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–æ–≤–µ—Ç:</b>",
        "savings_tips": "üíé <b>AI –°–æ–≤–µ—Ç—ã –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏:</b>",
        "investment_advice": "üìà <b>AI –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π —Å–æ–≤–µ—Ç:</b>",
        "back_to_ai": "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ AI –º–µ–Ω—é"
    },
    "en": {
        "ai_menu": "ü§ñ <b>AI TOOLS</b>\n\nSelect one of the AI functions:",
        "loading": "üß† AI is calculating...",
        "no_data": "‚ùå Not enough data for AI analysis. Add income/expenses first!",
        "ai_error": "‚ùå AI service issue. Try again later.",
        "budget_advice": "üí∞ <b>AI Budget Advice:</b>",
        "spending_analysis": "üìä <b>AI Spending Analysis:</b>",
        "goal_monitoring": "üéØ <b>AI Goal Monitoring:</b>",
        "financial_advice": "üí° <b>AI Financial Advice:</b>",
        "savings_tips": "üíé <b>AI Savings Tips:</b>",
        "investment_advice": "üìà <b>AI Investment Advice:</b>",
        "back_to_ai": "üîô Back to AI menu"
    }
}

async def show_ai_menu(update: Update, user_id: int):
    """Show AI tools menu"""
    try:
        keyboard = [
            ["üí∞ AI Byudjet Tavsiyasi", "üìä AI Xarajatlar Tahlili"],
            ["üéØ AI Maqsad Monitoring", "üí° AI Moliyaviy Maslahat"],
            ["üíé AI Tejash Maslahatlari", "üìà AI Investitsiya Maslahati"],
            ["üîô Orqaga"]
        ]
        
        if update.message:
            await update.message.reply_text(
                MESSAGES["uz"]["ai_menu"],
                reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True),
                parse_mode=ParseMode.HTML
            )
    except Exception as e:
        logger.exception(f"AI menu error: {e}")

async def show_ai_analysis(update: Update, user_id: int):
    """Show AI-powered spending analysis with loading and HTML/emoji formatting."""
    loading_msg = None
    try:
        if update.message:
            loading_msg = await update.message.reply_text(MESSAGES["uz"]["loading"])
        
        # Get user data for AI analysis
        settings = get_user_settings(user_id)
        currency = settings['currency']
        
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        c.execute("""
            SELECT type, amount, note, category, date 
            FROM transactions 
            WHERE user_id = ? 
            ORDER BY date DESC 
            LIMIT 20
        """, (user_id,))
        transactions = c.fetchall()
        conn.close()
        
        if not transactions:
            if loading_msg:
                await loading_msg.edit_text(MESSAGES["uz"]["no_data"])
            return
        
        # Prepare data for AI
        transaction_data = []
        for t in transactions:
            try:
                date_obj = datetime.strptime(t[4], "%Y-%m-%d %H:%M:%S")
                date_str = date_obj.strftime("%d.%m")
            except (ValueError, TypeError):
                date_str = "N/A"
            transaction_data.append({
                'type': t[0],
                'amount': t[1],
                'note': t[2],
                'category': t[3],
                'date': date_str
            })
        
        # Call AI service
        try:
            ai_analysis = await ai_service.analyze_spending_patterns(transaction_data)
        except Exception as e:
            logger.exception(f"AI analysis error: {e}")
            ai_analysis = MESSAGES["uz"]["ai_error"]
        
        if loading_msg:
            await loading_msg.edit_text(f"{MESSAGES['uz']['spending_analysis']}\n\n{ai_analysis}", parse_mode=ParseMode.HTML)
    except Exception as e:
        logger.exception(f"AI analysis error: {e}")
        if loading_msg:
            await loading_msg.edit_text(MESSAGES["uz"]["ai_error"])

async def show_ai_advice(update: Update, user_id: int):
    """Show AI financial advice with loading and HTML/emoji formatting."""
    loading_msg = None
    try:
        if update.message:
            loading_msg = await update.message.reply_text(MESSAGES["uz"]["loading"])
        
        # Get user data for AI advice
        settings = get_user_settings(user_id)
        currency = settings['currency']
        
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        
        # Get current month data
        current_month = datetime.now().strftime("%Y-%m")
        c.execute("""
            SELECT 
                SUM(CASE WHEN type = 'income' THEN amount ELSE 0 END) as income,
                SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END) as expense
            FROM transactions 
            WHERE user_id = ? AND strftime('%Y-%m', date) = ?
        """, (user_id, current_month))
        month_data = c.fetchone()
        
        # Get total data
        c.execute("""
            SELECT 
                SUM(CASE WHEN type = 'income' THEN amount ELSE 0 END) as income,
                SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END) as expense
            FROM transactions 
            WHERE user_id = ?
        """, (user_id,))
        total_data = c.fetchone()
        
        # Get top spending categories
        c.execute("""
            SELECT category, SUM(amount) 
            FROM transactions 
            WHERE user_id = ? AND type = 'expense' 
            GROUP BY category 
            ORDER BY SUM(amount) DESC 
            LIMIT 3
        """, (user_id,))
        categories = [cat[0] for cat in c.fetchall()]
        conn.close()
        
        # Prepare user data for AI
        month_income = month_data[0] or 0
        month_expense = month_data[1] or 0
        total_income = total_data[0] or 0
        total_expense = total_data[1] or 0
        
        user_data = {
            'month_income': month_income,
            'month_expense': month_expense,
            'total_income': total_income,
            'total_expense': total_expense,
            'currency': currency,
            'top_categories': categories
        }
        
        # Call AI service
        try:
            ai_advice = await ai_service.get_financial_advice(user_data)
        except Exception as e:
            logger.exception(f"AI advice error: {e}")
            ai_advice = ai_service.get_default_advice()
        
        if loading_msg:
            await loading_msg.edit_text(f"{MESSAGES['uz']['financial_advice']}\n\n{ai_advice}", parse_mode=ParseMode.HTML)
    except Exception as e:
        logger.exception(f"AI advice error: {e}")
        if loading_msg:
            await loading_msg.edit_text(MESSAGES["uz"]["ai_error"])

async def show_budget_advice(update: Update, user_id: int):
    """Show AI budget advice"""
    loading_msg = None
    try:
        if update.message:
            loading_msg = await update.message.reply_text(MESSAGES["uz"]["loading"])
        
        settings = get_user_settings(user_id)
        currency = settings['currency']
        
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        
        # Get current month data
        current_month = datetime.now().strftime("%Y-%m")
        c.execute("""
            SELECT 
                SUM(CASE WHEN type = 'income' THEN amount ELSE 0 END) as income,
                SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END) as expense,
                category, SUM(amount) as category_total
            FROM transactions 
            WHERE user_id = ? AND strftime('%Y-%m', date) = ? AND type = 'expense'
            GROUP BY category
            ORDER BY SUM(amount) DESC
        """, (user_id, current_month))
        category_data = c.fetchall()
        
        c.execute("""
            SELECT 
                SUM(CASE WHEN type = 'income' THEN amount ELSE 0 END) as income,
                SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END) as expense
            FROM transactions 
            WHERE user_id = ? AND strftime('%Y-%m', date) = ?
        """, (user_id, current_month))
        month_data = c.fetchone()
        conn.close()
        
        month_income = month_data[0] or 0
        month_expense = month_data[1] or 0
        
        # Generate budget advice
        if month_income == 0:
            advice = "üí∞ <b>Byudjet tavsiyasi:</b>\n\n‚ùå Oylik daromad ma'lumotlari yo'q. Avval daromadlaringizni kiritib, keyin qayta urinib ko'ring."
        else:
            savings_rate = ((month_income - month_expense) / month_income) * 100 if month_income > 0 else 0
            
            if savings_rate >= 20:
                status = "‚úÖ Ajoyib! Siz yaxshi tejayapsiz."
            elif savings_rate >= 10:
                status = "üëç Yaxshi! Tejash darajangiz yaxshi."
            elif savings_rate >= 0:
                status = "‚ö†Ô∏è Ehtiyot! Xarajatlaringizni kamaytiring."
            else:
                status = "‚ùå Xavfli! Daromadlaringizdan ko'p xarajat qilyapsiz."
            
            advice = f"""üí∞ <b>AI Byudjet Tavsiyasi:</b>

üìä <b>Oylik hisobot:</b>
‚Ä¢ Daromad: {format_amount(month_income, user_id)}
‚Ä¢ Xarajat: {format_amount(month_expense, user_id)}
‚Ä¢ Tejash: {format_amount(month_income - month_expense, user_id)}
‚Ä¢ Tejash foizi: {savings_rate:.1f}%

{status}

üí° <b>Tavsiyalar:</b>"""
            
            if savings_rate < 10:
                advice += "\n‚Ä¢ Xarajatlaringizni 20% kamaytiring"
                advice += "\n‚Ä¢ Ortiqcha xarajatlarni aniqlang"
                advice += "\n‚Ä¢ Daromadlaringizni oshiring"
            else:
                advice += "\n‚Ä¢ Yaxshi ishlayapsiz!"
                advice += "\n‚Ä¢ Investitsiya qilishni o'ylang"
                advice += "\n‚Ä¢ Zaxira pul yig'ing"
        
        if loading_msg:
            await loading_msg.edit_text(advice, parse_mode=ParseMode.HTML)
            
    except Exception as e:
        logger.exception(f"Budget advice error: {e}")
        if loading_msg:
            await loading_msg.edit_text(MESSAGES["uz"]["ai_error"])

async def show_savings_tips(update: Update, user_id: int):
    """Show AI savings tips"""
    loading_msg = None
    try:
        if update.message:
            loading_msg = await update.message.reply_text(MESSAGES["uz"]["loading"])
        
        # Get user spending patterns
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        
        c.execute("""
            SELECT category, SUM(amount) 
            FROM transactions 
            WHERE user_id = ? AND type = 'expense' 
            GROUP BY category 
            ORDER BY SUM(amount) DESC 
            LIMIT 5
        """, (user_id,))
        top_categories = c.fetchall()
        conn.close()
        
        tips = f"""üíé <b>AI Tejash Maslahatlari:</b>

üéØ <b>Asosiy tavsiyalar:</b>
‚Ä¢ Xarajatlaringizni kuzatib boring
‚Ä¢ Ortiqcha xarajatlarni kamaytiring
‚Ä¢ Daromadlaringizni oshiring
‚Ä¢ Zaxira pul yig'ing

üìä <b>Eng ko'p xarajat qiladigan kategoriyalar:</b>"""

        for i, (category, amount) in enumerate(top_categories, 1):
            tips += f"\n{i}. {category}: {format_amount(amount, user_id)}"
        
        tips += """

üí° <b>Tejash usullari:</b>
‚Ä¢ 50/30/20 qoidasi: 50% - asosiy xarajatlar, 30% - xohishlar, 20% - tejash
‚Ä¢ Avtomatik tejash o'rnating
‚Ä¢ Ortiqcha xarajatlarni aniqlang
‚Ä¢ Daromadlaringizni diversifikatsiya qiling

üéØ <b>Maqsadlar:</b>
‚Ä¢ Oylik daromadlaringizning 20%ini tejang
‚Ä¢ 3-6 oylik xarajatlaringiz miqdorida zaxira pul yig'ing
‚Ä¢ Uzoq muddatli maqsadlar uchun alohida hisob oching"""

        if loading_msg:
            await loading_msg.edit_text(tips, parse_mode=ParseMode.HTML)
            
    except Exception as e:
        logger.exception(f"Savings tips error: {e}")
        if loading_msg:
            await loading_msg.edit_text(MESSAGES["uz"]["ai_error"])

async def show_investment_advice(update: Update, user_id: int):
    """Show AI investment advice"""
    loading_msg = None
    try:
        if update.message:
            loading_msg = await update.message.reply_text(MESSAGES["uz"]["loading"])
        
        settings = get_user_settings(user_id)
        currency = settings['currency']
        
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        
        # Get user financial data
        c.execute("""
            SELECT 
                SUM(CASE WHEN type = 'income' THEN amount ELSE 0 END) as total_income,
                SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END) as total_expense
            FROM transactions 
            WHERE user_id = ?
        """, (user_id,))
        financial_data = c.fetchone()
        conn.close()
        
        total_income = financial_data[0] or 0
        total_expense = financial_data[1] or 0
        savings = total_income - total_expense
        
        if savings <= 0:
            advice = """üìà <b>AI Investitsiya Maslahati:</b>

‚ùå <b>Hozircha investitsiya qilish uchun yetarli mablag' yo'q.</b>

üí° <b>Avval quyidagilarni amalga oshiring:</b>
‚Ä¢ Xarajatlaringizni kamaytiring
‚Ä¢ Daromadlaringizni oshiring
‚Ä¢ 3-6 oylik zaxira pul yig'ing
‚Ä¢ Qarzlaringizni to'lang

üéØ <b>Keyingi qadamlar:</b>
‚Ä¢ Tejash darajangizni 20%ga yetkazing
‚Ä¢ Zaxira pul yig'ing
‚Ä¢ Moliyaviy maqsadlar qo'ying"""
        else:
            monthly_savings = savings / 12 if savings > 0 else 0
            
            advice = f"""üìà <b>AI Investitsiya Maslahati:</b>

üí∞ <b>Moliyaviy holat:</b>
‚Ä¢ Jami daromad: {format_amount(total_income, user_id)}
‚Ä¢ Jami xarajat: {format_amount(total_expense, user_id)}
‚Ä¢ Tejash: {format_amount(savings, user_id)}
‚Ä¢ O'rtacha oylik tejash: {format_amount(monthly_savings, user_id)}

üí° <b>Investitsiya tavsiyalari:</b>

üéØ <b>Boshlang'ich daraja:</b>
‚Ä¢ Bank depozitlari (5-10% yillik)
‚Ä¢ Davlat obligatsiyalari
‚Ä¢ Pul bozor fondlari

üìä <b>O'rta daraja:</b>
‚Ä¢ Aksiyalar (diversifikatsiya bilan)
‚Ä¢ ETF fondlari
‚Ä¢ Real estate investitsiyalari

üöÄ <b>Yuqori daraja:</b>
‚Ä¢ Kripto valyutalar (kichik miqdorda)
‚Ä¢ Venture capital
‚Ä¢ Xalqaro investitsiyalar

‚ö†Ô∏è <b>Eslatma:</b>
‚Ä¢ Investitsiya qilishdan oldin moliyaviy maslahatchi bilan maslahatlashing
‚Ä¢ Risk darajangizga mos investitsiya tanlang
‚Ä¢ Diversifikatsiya qilishni unutmang"""

        if loading_msg:
            await loading_msg.edit_text(advice, parse_mode=ParseMode.HTML)
            
    except Exception as e:
        logger.exception(f"Investment advice error: {e}")
        if loading_msg:
            await loading_msg.edit_text(MESSAGES["uz"]["ai_error"])

async def show_goal_monitoring(update: Update, user_id: int):
    """Show AI goal monitoring"""
    loading_msg = None
    try:
        if update.message:
            loading_msg = await update.message.reply_text(MESSAGES["uz"]["loading"])
        
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        
        # Get user goals
        c.execute("""
            SELECT name, target_amount, current_amount, deadline, created_at
            FROM goals 
            WHERE user_id = ? 
            ORDER BY created_at DESC
        """, (user_id,))
        goals = c.fetchall()
        conn.close()
        
        if not goals:
            advice = """üéØ <b>AI Maqsad Monitoring:</b>

‚ùå <b>Hozircha maqsadlar yo'q.</b>

üí° <b>Maqsad qo'yish tavsiyalari:</b>
‚Ä¢ Qisqa muddatli maqsadlar (3-6 oy)
‚Ä¢ O'rta muddatli maqsadlar (1-3 yil)
‚Ä¢ Uzoq muddatli maqsadlar (5+ yil)

üéØ <b>Maqsad turlari:</b>
‚Ä¢ Tejash maqsadlari
‚Ä¢ Investitsiya maqsadlari
‚Ä¢ Xarid maqsadlari
‚Ä¢ Ta'lim maqsadlari

üìä <b>Maqsad qo'yish qoidalari:</b>
‚Ä¢ Aniq va o'lchanadigan bo'lishi
‚Ä¢ Vaqt chegarasi bo'lishi
‚Ä¢ Realistik bo'lishi
‚Ä¢ Yozib qo'yilgan bo'lishi"""
        else:
            advice = f"""üéØ <b>AI Maqsad Monitoring:</b>

üìä <b>Maqsadlar holati:</b>"""

            for i, (name, target, current, deadline, created) in enumerate(goals, 1):
                progress = (current / target * 100) if target > 0 else 0
                remaining = target - current
                
                # Calculate days remaining
                try:
                    deadline_date = datetime.strptime(deadline, "%Y-%m-%d")
                    days_remaining = (deadline_date - datetime.now()).days
                    deadline_status = f"‚è∞ {days_remaining} kun qoldi" if days_remaining > 0 else "‚è∞ Vaqt tugadi"
                except:
                    deadline_status = "‚è∞ Vaqt aniqlanmagan"
                
                status_emoji = "‚úÖ" if progress >= 100 else "üîÑ" if progress >= 50 else "‚è≥"
                
                advice += f"""

{i}. <b>{name}</b>
{status_emoji} Progress: {progress:.1f}%
üí∞ Joriy: {format_amount(current, user_id)} / {format_amount(target, user_id)}
üíµ Qolgan: {format_amount(remaining, user_id)}
{deadline_status}"""

            advice += """

üí° <b>Monitoring tavsiyalari:</b>
‚Ä¢ Maqsadlaringizni muntazam tekshiring
‚Ä¢ Progressni kuzatib boring
‚Ä¢ Kerak bo'lsa maqsadlarni o'zgartiring
‚Ä¢ Muvaffaqiyatni nishonlang"""

        if loading_msg:
            await loading_msg.edit_text(advice, parse_mode=ParseMode.HTML)
            
    except Exception as e:
        logger.exception(f"Goal monitoring error: {e}")
        if loading_msg:
            await loading_msg.edit_text(MESSAGES["uz"]["ai_error"])

async def handle_ai_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle AI menu selections"""
    if not update.message or not update.message.text or not hasattr(update.message, 'from_user'):
        return ConversationHandler.END
    
    text = update.message.text
    user_id = getattr(getattr(update.message, 'from_user', None), 'id', None)
    
    if not user_id:
        return ConversationHandler.END
    
    if text == "üí∞ AI Byudjet Tavsiyasi":
        await show_budget_advice(update, user_id)
    elif text == "üìä AI Xarajatlar Tahlili":
        await show_ai_analysis(update, user_id)
    elif text == "üéØ AI Maqsad Monitoring":
        await show_goal_monitoring(update, user_id)
    elif text == "üí° AI Moliyaviy Maslahat":
        await show_ai_advice(update, user_id)
    elif text == "üíé AI Tejash Maslahatlari":
        await show_savings_tips(update, user_id)
    elif text == "üìà AI Investitsiya Maslahati":
        await show_investment_advice(update, user_id)
    elif text == "üîô Orqaga":
        from handlers.start import start
        return await start(update, context)
    else:
        await update.message.reply_text("‚ùå Noto'g'ri tanlov. Qaytadan tanlang.")
    
    return ConversationHandler.END 